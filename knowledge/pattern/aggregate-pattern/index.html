<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Moon Smile">
        
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>Aggregate Pattern - Note Pro</title>
        <link href="../../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
	
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
	<script src="../../../js/somelib.js"></script>

        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-36723568-3', 'mkdocs.org');
            ga('send', 'pageview');
        </script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../../..">Note Pro</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../../..">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Daily Plans <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../../daily-plans/plans-version-1.1/">Version 1</a>
</li>
                                    
<li >
    <a href="../../../daily-plans/plans-version-2/">Version 2</a>
</li>
                                    
<li >
    <a href="../../../daily-plans/plans-version-3/">Version 3</a>
</li>
                                    
<li >
    <a href="../../../daily-plans/plans-version-3.1/">Version 3.1</a>
</li>
                                    
<li >
    <a href="../../../daily-plans/soft-skills-for-learning/">Soft Skills for Learning</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">KnowLedge <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#">Principles</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../principles/s-o-l-i-d/">S.O.L.I.D</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Pattern</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../dependency-injection/">Dependency Injection</a>
</li>
            
<li >
    <a href="../design_pattern/">Design Pattern</a>
</li>
            
<li class="active">
    <a href="./">Aggregate Pattern</a>
</li>
            
<li >
    <a href="../the-7-most-important-software-design-patterns/">The 7 mose important software design pattern</a>
</li>
            
<li >
    <a href="../repository-pattern/">Repository Pattern</a>
</li>
            
<li >
    <a href="../specification-pattern/">Specification Pattern</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Algorithms</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../algorithms/analysis-of-algorithms/">Analysis of Algorithms</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Architectures</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../architectures/three-tier/">Three tier</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">DevOps</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">Circle CI</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../dev-ops/circle-ci/writing-yaml/">Writing YAML</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Docker</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../dev-ops/docker/docker-network/">Docker Network</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Web Development</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">Basics</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../web-development/basics/code-coverage/">Code Coverage</a>
</li>
            
<li >
    <a href="../../web-development/basics/regression-testing/">Regression Testing</a>
</li>
            
<li >
    <a href="../../web-development/basics/functional-testing/">Functional Testing</a>
</li>
            
<li >
    <a href="../../web-development/basics/integration-testing/">Integration Testing</a>
</li>
            
<li >
    <a href="../../web-development/basics/unit-testing/">Unit Testing</a>
</li>
            
<li >
    <a href="../../web-development/basics/css-handbook/">CSS HandBook</a>
</li>
            
<li >
    <a href="../../web-development/basics/introducing-websockets/">Introducing WebSockets</a>
</li>
            
<li >
    <a href="../../web-development/basics/graphql/">GraphQL</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">ASP.NET</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../web-development/asp.net/introduction/">Introduction</a>
</li>
            
<li >
    <a href="../../web-development/asp.net/nswag/">NSwag</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">NodeJS</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../web-development/nodejs/libuv/">Libuv</a>
</li>
            
<li >
    <a href="../../web-development/nodejs/overview-of-blocking-and-non-blocking/">Overview of Blocking and Non-Blocking</a>
</li>
            
<li >
    <a href="../../web-development/nodejs/what-is-the-event-loop/">The Node.js Event Loop</a>
</li>
            
<li >
    <a href="../../web-development/nodejs/get-started.md">Get Started</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Ruby On Rails</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../web-development/ruby-on-rails/overview.md">Overview</a>
</li>
            
<li >
    <a href="../../web-development/ruby-on-rails/rails-form-expand/">Rails Form Expand</a>
</li>
            
<li >
    <a href="../../web-development/ruby-on-rails/rails-active-record-callbacks/">Active Record Callbacks</a>
</li>
            
<li >
    <a href="../../web-development/ruby-on-rails/action-view-form-helpers.md">Action View Form Helpers</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Stories</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">Skill Blog</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../stories/skill-blog/how-to-be-a-great-programmer/">How to be a great programmer</a>
</li>
            
<li >
    <a href="../../stories/skill-blog/what-javascript-developers-learn-from-c++/">What Javascript Developers can learn from C++</a>
</li>
            
<li >
    <a href="../../stories/skill-blog/what-i-learn-from-lauching-a-freelance-writing-bussiess.md">What I learn from lauching a freelance writing business</a>
</li>
            
<li >
    <a href="../../stories/skill-blog/how-code-reviews-work-at-microsoft/">How code reviews work at Microsoft</a>
</li>
            
<li >
    <a href="../../stories/skill-blog/how-to-debug-with-firefox/">How to debug web apps with Firefox developer tools</a>
</li>
            
<li >
    <a href="../../stories/skill-blog/beyond-coding-soft-skill-to-avoid-projects-fails/">Beyond Coding - Soft skill to avoid projects failures</a>
</li>
            
<li >
    <a href="../../stories/skill-blog/3-things-to-do-when-you-dont-have-computers-science-degree/">3 Things to do when you don't have computer science degree</a>
</li>
            
<li >
    <a href="../../stories/skill-blog/net-core-is-future-of-net/">.NET Core is Future of .NET</a>
</li>
            
<li >
    <a href="../../stories/skill-blog/introducing-net-5/">Introducing .NET 5</a>
</li>
            
<li >
    <a href="../../stories/skill-blog/scraping-the-web-with-nodejs/">Scraping Web With Nodejs</a>
</li>
            
<li >
    <a href="../../stories/skill-blog/roadmap-web-developer-2019/">Roadmap Web Developer 2019</a>
</li>
            
<li >
    <a href="../../stories/skill-blog/tinygo/">Tiny Go</a>
</li>
            
<li >
    <a href="../../stories/skill-blog/net-stacks/">.NET stacks</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Dev Ops</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../stories/devops-blog/what-is-devops-and-why-do-we-need-it/">What is DevOps? Why do we need it?</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Computer Science</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../stories/computer-science/what-is-different-between-machine-learning-and-ai/">What is between machine learning and AI</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Blockchain</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../stories/blockchain-blog/matic-developer-support-program/">Matic Developer Support Program</a>
</li>
            
<li >
    <a href="../../stories/blockchain-blog/what-is-matic-network/">What Is Matic Network</a>
</li>
            
<li >
    <a href="../../stories/blockchain-blog/plasma/">Plasma</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Thinking In Art</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../stories/thinking-in-art/you-could-have-today-instead-you-choose-tomorrow/">You Could Have Today Intead You Choose Tomorrow</a>
</li>
            
<li >
    <a href="../../stories/thinking-in-art/how-to-quit-your-job-and-live-your-startup-dream/">How to quit your job and live your startup dream</a>
</li>
            
<li >
    <a href="../../stories/thinking-in-art/how-two-words-can-change-your-life/">How two words can change your life</a>
</li>
            
<li >
    <a href="../../stories/thinking-in-art/4-practical-things-i-do-to-stay-positive/">4 Practical Things I do to stay positive</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Xamarin Blog</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../stories/xamarin-blog/getting-started-workmanager/">Getting Started WorkManager</a>
</li>
            
<li >
    <a href="../../stories/xamarin-blog/sharing-files-and-email-attachments/">Sharing Files and Email Attachment</a>
</li>
            
<li >
    <a href="../../stories/xamarin-blog/add-a-backend-to-your-app-in-10-minutes/">Add a Backend to Your App in 10 minutes</a>
</li>
            
<li >
    <a href="../../stories/xamarin-blog/behavior-xamarin/">Behavior In Xamarin Forms</a>
</li>
            
<li >
    <a href="../../stories/xamarin-blog/shrinking-your-android-app-size/">Shrinking Your Android App Size</a>
</li>
            
<li >
    <a href="../../stories/xamarin-blog/mobile-tools-for-designers/">Mobile Tools for Designer</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Mobile Development</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../mobile-development/overview/">Overview</a>
</li>
            
  <li class="dropdown-submenu">
    <a href="#">Xamarin</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../mobile-development/xamarin/xamarin-forms-shell/">Xamarin Forms Shell</a>
</li>
            
<li >
    <a href="../../mobile-development/xamarin/controls-reference/">Controls Reference</a>
</li>
            
<li >
    <a href="../../mobile-development/xamarin/customizing-listview-cell-appearance/">Customizing ListView cell Appearence</a>
</li>
            
<li >
    <a href="../../mobile-development/xamarin/data-pages/">Data Pages</a>
</li>
            
<li >
    <a href="../../mobile-development/xamarin/data-pages-controls/">Data Pages Controls</a>
</li>
            
<li >
    <a href="../../mobile-development/xamarin/triggers/">Triggers</a>
</li>
            
<li >
    <a href="../../mobile-development/xamarin/xamarin-forms-theme/">Themes</a>
</li>
            
  <li class="dropdown-submenu">
    <a href="#">Template</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../mobile-development/xamarin/templates/overview/">Overview</a>
</li>
            
<li >
    <a href="../../mobile-development/xamarin/templates/control-templates/">Control Templates</a>
</li>
            
<li >
    <a href="../../mobile-development/xamarin/templates/data-templates/">Data Templates</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
    </ul>
  </li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../design_pattern/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../the-7-most-important-software-design-patterns/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/MoonSmile1707/NotePro/blob/master/docs/knowledge/pattern/aggregate-pattern.md"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#aggregate-pattern">Aggregate Pattern</a></li>
            <li><a href="#problem">Problem</a></li>
            <li><a href="#aggregate-pattern_1">Aggregate Pattern</a></li>
            <li><a href="#one-aggregate-per-transaction">One Aggregate Per transaction</a></li>
            <li><a href="#keep-the-aggregates-small">Keep The Aggregates Small</a></li>
            <li><a href="#eventual-consistency">Eventual Consistency</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="aggregate-pattern">Aggregate Pattern</h1>
<p>Aggregates are alla bout transactional consistency. When there is a strong consistency rule between multiple entities, we make one of them responsible for enforcing it.</p>
<hr/>

<h2 id="problem">Problem</h2>
<p>Imagine that you're writing yet another e-commerce appilcation and you're tasked with writing the all-important Order class:</p>
<pre><code class="java">
@Entity
public class Order {
    private String id;
    private Instant date;
    private List&lt;OrderPosition&gt; orderPositions;
    // stuff
}
@Entity
public class OrderPosition {
    private String id;
    private String name;
    private BigDecimal quantity;
    // stuff
}
</code></pre>

<p>Until the order is packed and ready to ship, customers are allowed to add a position to it:</p>
<pre><code class="java">public class OrderService {
    // fields, c-tor
    public void addPosition(String orderId, String productId, BigDecimal quantity) {
        // stuff
    }
}
</code></pre>

<p>Now, the business has asked you to limit the possibility to order more than 100 hundred items or for more than $5,000. How do you ensure that these criteria are met, considering the fact that you're working in a concurrent environment and using a relational database?</p>
<h2 id="aggregate-pattern_1">Aggregate Pattern</h2>
<p>This is aclassic usage example of the fmous Aggregate Pattern. Although some try to identify aggregates by looking for matching domain concepts, the pattern's real purpose is to help you ensure transactional consistency and performing persistence operations just on this entity. We call such entity an aggregate root. Any other entities that are "ensured" consistent have to be saved in a single transaction by saving the aggregate root itself.</p>
<p>Applying this to our example, we could say the Order class should be an aggregate over OrderPosition class. This implies the following:</p>
<ul>
<li>The Order class is responsible for ensuring the maximum amount of postions and their maximum balance.</li>
<li>The Order class requires some concurrency mechanism e.g. optimistic locking (AKA versioning).</li>
<li>There will be an OrderRepository class in the system, but not an OrderPositionRepository class.</li>
<li>The addPosition operation has to be performed in a transaction.</li>
</ul>
<pre><code class="java">@Entity
public class Order {
    private String id;
    private Long version; // optimistic locking!
    // other fields, c-tor
    public void addPosition(Product product, BigDecimal quantity) {
        if (hasMaxPositions()) {
            throw new TooManyPositionsException(id);
        }
        if (valueTooHigh(product.getPrice().times(quantity))) {
            throw new ValueTooHighException(id);
        }
        // stuff
    }
}
public class OrderService {
    // fields, c-tor
    @Transactional
    public void addPosition(String orderId, String productId, BigDecimal quantity) {
        Order order = orderRepository.findById(orderId);
        Product product = productRepository.findById(productId);
        order.addPosition(product, quantity);
        orderRepository.save(order);
    }
}
</code></pre>

<h2 id="one-aggregate-per-transaction">One Aggregate Per transaction</h2>
<p>There's a good rule for working with aggregates that says that <strong>we should not update more than one aggregate per transaction</strong>. It makes perect sense. Look, if I'm saying that consistency rules lie within the aggregate, then I should be able to save only this one, single aggregate - and everything should stay consistent. If that's not the case, maybe I'm missing an "uber-aggregate" on top of the two that I want to update in a single transaction. Or maybe these rules don't call for transactional consistency at all!</p>
<p>The rule of one aggregate per transaction has also a usability argument on its side. Imagine the following scenario:</p>
<p>If our users are trying to deal with the same aggregates at the same time, the risk of having a failed transaction grows. User 2 could prevent the tow other users from saving their work and, at the same time, any of the two other users could prevent user 3 from saving his or her work. That's not a desirable state of things. By limiting the transactions to one aggregate, we reduce the risk of failed concerrent transactions and therefore improve the usability of our application.</p>
<h2 id="keep-the-aggregates-small">Keep The Aggregates Small</h2>
<p>The rule above and the way programmers think combine in a pretty strong force towards big aggregates. Let's say that someone added a status field to the Order class:</p>
<pre><code class="java">public enum OrderStatus {
    UNPAID, PAID, IN_DELIVERY, COMPLETED
}
</code></pre>

<p>The business asks you to change the status to PAID once 99% of the order value is paid, to IN_DELIVERY once the guy at the warehouse starts to fill the parcels, and to COMPLETED once all parcels ae delivered. Does that mean that the Order class should now take care of payments, parcels, and trackng the guy at the warehouse? The resulting aggregate would be a giant class with lots of responsibilities, just for the sake of maintaining consistency. Also, performance would suffer badly and the risk of a failed transaction would grow significantly. That's a pretty extreme vision, but it shows the limits of the Aggregate pattern's applicability.</p>
<h2 id="eventual-consistency">Eventual Consistency</h2>
<p>Things are usually not that bad. If you go and ask the business whether ist's okay for the order status to be updated a few seconds after the payment has been received or the parcel is delivered, they will most likely answer positively. Programmers often envision temporary lack of consistency as something evil and dangerous. That's a nerd point of view. When the business guys say consistent, they usually mean eventually consistent, and often, it could be even later than a few seconds.</p>
<p><strong>There fore, talk to the business guys and embrace eventual consistency, when the domain allows it, to keep your aggregates small and your code simple.</strong></p>
<hr/>

<p>Get more information at <a href="https://dzone.com/articles/aggregate-pattern">here</a>.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Moon Smile 2019</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../js/base.js" defer></script>
        <script src="../../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
